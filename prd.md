# PRD: 비주얼 매크로 편집기 및 자동화 실행기

- **문서 버전:** 2.1 (v2.0: GUI 편집기, v2.1: UX 개선 및 실행 제어 강화)
- **작성 날짜:** 2025년 11월 21일
- **프로젝트 오너:** (사용자)

---

## 1. 개요

**비주얼 매크로 편집기**는 사용자가 코딩 없이 그래픽 사용자 인터페이스(GUI)를 통해 데스크톱 자동화 워크플로우를 직접 생성, 편집, 실행할 수 있는 애플리케이션입니다.

사용자는 **'조건(Condition)'** (예: 화면에서 특정 이미지/텍스트 찾기, 시간 대기)과 **'액션(Action)'** (예: 마우스 클릭, 키보드 입력, 특정 단계로 이동)을 조합하여 복잡한 반복 작업을 자동화할 수 있습니다.

## 2. 프로젝트 목표

- **직관적인 자동화 생성:** 사용자가 GUI를 통해 시각적으로 자동화 스텝을 추가하고 편집할 수 있도록 합니다.
- **유연한 워크플로우:** 단순 반복뿐만 아니라 'N번으로 되돌아가기(Goto)' 기능을 통해 분기 및 반복 로직을 구현합니다.
- **쉬운 배포:** OCR 엔진(`EasyOCR`)을 내장하여, 사용자가 별도 프로그램을 설치할 필요 없는 단일 실행 파일로 배포합니다.
- **크로스 플랫폼:** Windows와 macOS 환경 모두에서 핵심 기능이 동일하게 작동하도록 보장합니다.

## 3. 핵심 기능 (Functional Requirements)

### 3.0. 워크플로우 관리자 (Startup)

- **목록 관리:** 앱 시작 시 워크플로우 관리자에서 기존 워크플로우를 목록으로 표시합니다.
- **선택 후 조작:** 워크플로우가 선택된 경우에만 **편집(열기 → 편집)**, **실행**이 가능합니다.
- **실행 제어:** 실행 중일 때만 **정지** 버튼이 활성화됩니다. 실행 중에는 **삭제 불가**입니다.
- **생성/저장 구조:** 새로 만들기 시 워크플로우 폴더를 생성하고, 편집 화면에서 저장 시 폴더 내에 `flow.json`과 `assets/`(타겟 이미지 등)를 관리합니다.

### 3.1. GUI - 워크플로우 편집기

- **상단 최소화:** 편집 화면에는 저장/취소 위주로 간소화하며, 새로 만들기/불러오기/실행/정지는 관리자 화면에서 수행합니다.
- **스텝 목록:** 스텝을 순서대로 표시하며, 각 항목에 **아이콘(조건/액션 타입)**과 **요약 설명**을 표시하여 가독성을 높입니다.
- **하단 버튼:** "저장", "취소" 버튼 외에 **"현재 스텝 테스트"** 버튼을 추가하여 선택한 스텝만 즉시 실행해볼 수 있도록 합니다.
- **이미지 미리보기:** '이미지 인식' 조건의 경우, 캡처된 타겟 이미지를 속성 패널에서 **썸네일**로 미리 보여줍니다.
- **로깅:** 편집 화면 하단에 간단한 상태 로그를 표시합니다.

### 3.2. 스텝 정의: 조건 (Condition)

사용자가 "스텝 추가" 시 선택할 수 있는 조건 유형입니다.

- **[이미지 인식]**
    - "타겟 캡처" 클릭 시, 사용자가 화면에서 원하는 영역을 드래그하여 **타겟 이미지**를 캡처합니다.
    - 캡처된 타겟 이미지는 현재 워크플로우의 `assets/` 폴더에 **임의 파일명**으로 자동 저장됩니다(예: `target_xxxxxxxx.png`).
    - "다중 매치 처리 모드": '단일' 또는 '순차(좌상단→우하단)'를 선택할 수 있습니다.
    - "정렬 기준": 좌상단 우선(y→x)으로 동일 이미지의 여러 매치를 정렬합니다.
    - "중복 제외 반경(px)": 이미 처리(클릭)한 매치와의 최소 거리로 중복 클릭을 방지합니다.
    - "탐색 간격(ms)" 및 "타임아웃(s)": 재탐지 주기와 최대 대기 시간을 설정합니다.
- **[텍스트 인식]**
    - (입력 1) 사용자가 찾을 텍스트(`target_text`)를 입력합니다.
    - (입력 2) "영역 지정" 버튼 클릭 시, 사용자가 텍스트를 *찾을* 화면 영역(`watch_area`)을 마우스로 드래그하여 지정합니다.
- **[시간 대기]**
    - 사용자가 대기할 시간(초)을 입력합니다. 이 조건은 항상 '성공'으로 처리됩니다.

### 3.3. 스텝 정의: 액션 (Action)

조건이 충족되었을 때 실행할 액션 유형입니다.

- **[마우스 클릭]**
    - 사용자가 직접 클릭할 (x, y) 좌표를 **화면에서 선택**하여 지정합니다. (좌표 선택 시 화면 디밍 + ESC 취소 지원)
    - (다중 매치 모드) 조건이 '이미지 인식'이고 "순차(좌상단→우하단)" 모드일 때, 엔진은 미방문 매치를 좌상단부터 하나씩 선택해 클릭하며, 매 클릭 후 재탐지하여 다음 타겟을 처리합니다.
- **[N번 스텝으로 이동 (Goto)]**
    - 사용자가 되돌아가거나 점프할 스텝의 번호(N)를 입력합니다. (예: 1번 스텝으로 되돌아가기)
- **[액션 없음]**
    - 조건(예: 시간 대기)만 수행하고 다음 스텝으로 넘어갑니다.

### 3.4. 실행 엔진 및 러너 UI (Executor & Runner)

- **러너 UI (Runner Window):**
    - 실행 시 별도의 작은 창(또는 오버레이)이 뜨며, **현재 실행 중인 스텝 번호/이름**을 표시합니다.
    - **[중지 (Stop)]** 버튼을 크게 배치하여 언제든 실행을 멈출 수 있게 합니다.
    - 실행 로그를 실시간으로 표시합니다.
- **글로벌 단축키:** 실행 중 `F12` (또는 설정된 키)를 누르면 즉시 강제 종료합니다.
- **순차 실행:** "시작" 버튼 클릭 시, 작업 목록의 1번 스텝부터 순차적으로 실행합니다.
- **조건부 실행:**
    1.  현재 스텝의 **'조건'**을 먼저 확인합니다.
    2.  '이미지/텍스트 인식' 조건이 충족될 때까지 해당 스텝에서 대기합니다. (무한 대기 또는 타임아웃 설정 필요)
    3.  '시간 대기' 조건은 지정된 시간만큼 대기합니다.
    4.  조건이 충족되면, 연결된 **'액션'**을 1회 실행합니다.
- **흐름 제어:** 'N번 스텝으로 이동' 액션이 실행되면, 다음 실행 순서를 해당 N번 스텝으로 즉시 변경합니다.
 - **다중 매치 처리(이미지 인식 + 순차 모드):**
    - `watch_area`에서 동일 템플릿의 모든 매치를 수집하고 (y, x) 오름차순으로 정렬합니다.
    - 실행 세션 동안 방문(클릭) 좌표 목록을 유지합니다. "중복 제외 반경(px)"보다 가까운 매치는 이미 방문한 것으로 간주하고 건너뜁니다.
    - 미방문 매치를 좌상단부터 하나 선택해 클릭 → 짧은 대기(탐색 간격) → 화면을 재탐지 → 다음 타겟을 동일 규칙으로 처리합니다.
    - 더 이상 남은 매치가 없거나 타임아웃 도달 시 본 스텝을 종료하고 다음 스텝으로 진행합니다.
 - **스텝 실행 간격:** 각 스텝은 "기본 실행 간격(ms)"을 가지며(기본값 5ms), 액션 수행 후 다음 루프/스텝으로 넘어가기 전에 적용됩니다.
 - **반복 대기:** 이미지가 없을 때는 지정된 탐색 간격으로 재탐지(반복)하며, 타임아웃 시 지정 액션(예: Goto N)으로 제어할 수 있습니다.

### 3.5. 프로젝트 관리

- **저장/불러오기:** 사용자가 GUI에서 생성한 (조건 + 액션) 작업 목록 전체를 단일 파일(예: `.json` 형식)으로 저장하거나 불러올 수 있습니다.
 - **저장 구조:** 워크플로우는 디렉터리 단위로 관리합니다. `workflows/<이름>/flow.json` + `assets/`(타겟 이미지 등). `flow.json`에는 자산 경로를 **상대 경로**로 기록합니다.

### 3.6. 스텝 유형 (Step Types) 및 간격

- **스텝 유형:** `[일반]`, `[조건]`, `[반복]`을 제공합니다. 유형은 실행 의미를 명료하게 표현하기 위함이며, 각 스텝별로 **기본 실행 간격(ms)**을 설정할 수 있습니다. 기본값은 **5ms**입니다.
- **액션 유형 제한:** 스텝 액션은 `click`, `goto`를 지원합니다. `click`은 좌표 선택이 **필수**입니다.

### 3.7. 캡처/좌표 선택 UX

- **디밍 오버레이:** 캡처/좌표 선택 시 화면 전체를 어둡게 처리하고, 드래그 중인 선택 영역만 원래 밝기로 표시합니다.
- **ESC 취소:** 드래그/선택 중 `ESC` 키로 즉시 취소할 수 있습니다.
- **커서:** 십자 커서 표시.
- **DPR 대응:** macOS Retina/Windows 배율 환경에서 디바이스 픽셀 비율(DPR)을 반영하여 실제 화면 좌표와 일치하도록 캡처/좌표를 계산합니다.

### 3.8. 용어 정리

- "템플릿 이미지" → **"타겟 이미지"**로 통일합니다.

## 4. 기술 요구사항 (Non-Functional Requirements)

- **개발 언어:** Python 3.9+
- **배포:** `PyInstaller`를 사용한 단일 실행 파일 (.exe, .app)로 패키징합니다.
- **GUI 라이브러리:** **`PyQt`** (권장) 또는 `Tkinter`. GUI의 복잡도를 고려할 때 `PyQt`가 더 강력한 기능을 제공합니다.
- **핵심 라이브러리:**
    - `PyAutoGUI` (마우스/키보드 제어, 화면 캡처)
    - `EasyOCR` (내장형 텍스트 인식, `ko`/`en` 모델만 로드)
    - `Pillow` (이미지 처리)
    - `pynput` (선택 사항: 화면 캡처 시 마우스 드래그 이벤트를 더 쉽게 처리하기 위해)
    - `opencv-python` (PyAutoGUI의 `confidence` 기반 템플릿 매칭 및 다중 매치 지원)
- **성능:** OCR 스캔은 `watch_area`로 한정하여 시스템 부하를 최소화합니다. 실행 엔진의 메인 루프는 CPU 과부하를 막기 위해 적절한 `time.sleep()` (예: 0.1초)을 포함해야 합니다.
 - **다중 매치 성능:** `watch_area`를 좁히고, `confidence`/`중복 제외 반경`/탐색 간격을 조절하여 클릭→재탐지 루프의 부하를 관리합니다.
- **디스플레이 스케일 대응:** 캡처/좌표 선택/매칭 시 디바이스 픽셀 비율(DPR)을 고려해야 합니다.
- **플랫폼 호환성 (macOS):**
    - macOS에서 실행 시, **[시스템 설정] > [개인정보 보호 및 보안] > [손쉬운 사용]** 및 **[화면 기록]** 권한이 앱(터미널, 또는 패키징된 .app)에 부여되어야 함을 사용자에게 명확히 안내해야 합니다.

## 5. 사용자 작업 흐름 (예시)

1.  (사용자) 프로그램을 실행하고 "새 자동화" 버튼을 클릭합니다.
2.  (사용자) **[스텝 1 추가]**
    - **조건:** [이미지 인식] 선택 -> "화면 캡처" 클릭 -> 화면의 "로그인" 버튼 이미지를 드래그하여 캡처.
    - **액션:** [마우스 클릭] 선택 (찾은 이미지 중앙 클릭).
3.  (사용자) **[스텝 2 추가]**
    - **조건:** [시간 대기] 선택 -> 3 (초) 입력.
    - **액션:** [액션 없음] 선택.
4.  (사용자) **[스텝 3 추가]**
    - **조건:** [텍스트 인식] 선택 -> 텍스트: "에러", 영역: 화면 중앙 팝업 영역을 드래그하여 지정.
    - **액션:** [N번 스텝으로 이동] 선택 -> 1 (번) 입력.
5.  (사용자) "저장하기"를 눌러 이 워크플로우를 "login_macro.json"으로 저장합니다.
6.  (사용자) "자동화 시작" 버튼을 클릭합니다.
7.  **(엔진)** "로그인" 버튼이 보일 때까지 대기 -> 찾으면 클릭 (스텝 1) -> 3초 대기 (스텝 2) -> "에러" 텍스트가 팝업 영역에 나타나는지 감시 (스텝 3) -> "에러" 텍스트 발견 시 1번 스텝("로그인" 버튼 찾기)으로 되돌아감.
8.  (사용자) "중지" 버튼을 눌러 자동화를 종료합니다.

## 6. 범위 외 (Out of Scope)

- **복잡한 로직:** 변수 사용, 조건부 분기(If/Else), API 연동 등 고급 RPA 기능.
- **백그라운드 실행:** 이 매크로는 화면을 직접 제어하므로, 실행 중에는 사용자가 컴퓨터를 사용하기 어렵습니다.